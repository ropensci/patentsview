<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Writing queries • patentsview</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">patentsview</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/getting-started.html">
    <span class="fa fa-play"></span>
     
    Getting started
  </a>
</li>
<li>
  <a href="../articles/writing-queries.html">
    <span class="fa fa-pencil"></span>
     
    Writing queries
  </a>
</li>
<li>
  <a href="../articles/examples.html">
    <span class="fa fa-code"></span>
     
    Examples
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-bar-chart"></span>
     
    Applications
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/top-assignees.html">
        <span class="fa fa-university"></span>
         
        Top assignees
      </a>
    </li>
    <li>
      <a href="../articles/citation-networks.html">
        <span class="fa fa-long-arrow-left"></span>
         
        Citation networks
      </a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">
    <span class="fa fa-info-circle"></span>
     
    Reference
  </a>
</li>
<li>
  <a href="https://github.com/ropensci/patentsview">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Writing queries</h1>
            
          </div>

    
    
<div class="contents">
<div id="three-ways-to-write-the-same-query" class="section level2">
<h2 class="hasAnchor">
<a href="#three-ways-to-write-the-same-query" class="anchor"></a>Three ways to write the same query</h2>
<p>There are three different ways that you can create a query to pass to <code><a href="../reference/search_pv.html">search_pv()</a></code>. For example, let’s say you want to find all patents published in the last 10 years that have the word “dog” in their titles or abstracts, and whose assignees are located in either the US or Canada. Here are the three options for how you could write such a query:</p>
<ol style="list-style-type: decimal">
<li>Use a raw character/JSON vector:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">query_v_1 &lt;-
<span class="st">  '{"_and":[</span>
<span class="st">          {"_gte":{"patent_date":"2007-03-01"}},</span>
<span class="st">          {"_or":[</span>
<span class="st">            {"_text_all":{"patent_title":"dog"}},</span>
<span class="st">            {"_text_all":{"patent_abstract":"dog"}}</span>
<span class="st">          ]},</span>
<span class="st">          {"_or":[</span>
<span class="st">            {"_eq":{"assingee_country":"US"}},</span>
<span class="st">            {"_eq":{"assingee_country":"CA"}}</span>
<span class="st">          ]}</span>
<span class="st">  ]}'</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Use a list (which will be converted to JSON by <code><a href="../reference/search_pv.html">search_pv()</a></code>):</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">query_v_2 &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">list</span>(<span class="st">"_and"</span> =<span class="st"> </span>
<span class="st">       </span><span class="kw">list</span>(
          <span class="kw">list</span>(<span class="st">"_gte"</span> =<span class="st"> </span><span class="kw">list</span>(<span class="dt">patent_date =</span> <span class="st">"2007-03-01"</span>)),
          <span class="kw">list</span>(<span class="st">"_or"</span> =<span class="st"> </span>
<span class="st">                 </span><span class="kw">list</span>(
                   <span class="kw">list</span>(<span class="st">"_text_all"</span> =<span class="st"> </span><span class="kw">list</span>(<span class="dt">patent_title =</span> <span class="st">"dog"</span>)),
                   <span class="kw">list</span>(<span class="st">"_text_all"</span> =<span class="st"> </span><span class="kw">list</span>(<span class="dt">patent_abstract =</span> <span class="st">"dog"</span>))
                   )
               ),
          <span class="kw">list</span>(<span class="st">"_or"</span> =<span class="st"> </span>
<span class="st">                 </span><span class="kw">list</span>(
                   <span class="kw">list</span>(<span class="st">"_eq"</span> =<span class="st"> </span><span class="kw">list</span>(<span class="dt">assingee_country =</span> <span class="st">"US"</span>)),
                   <span class="kw">list</span>(<span class="st">"_eq"</span> =<span class="st"> </span><span class="kw">list</span>(<span class="dt">assingee_country =</span> <span class="st">"CA"</span>))
                   )
               )
      )
  )</code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Use the domain specific language (DSL) provided in <code>patentsview</code> to create an object of class <code>pv_query</code> (which is also a list):</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(patentsview)

query_v_3 &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/with_qfuns.html">with_qfuns</a></span>(
    <span class="kw">and</span>(
      <span class="kw">gte</span>(<span class="dt">patent_date =</span> <span class="st">"2007-03-01"</span>),
      <span class="kw">or</span>(
        <span class="kw">text_all</span>(<span class="dt">patent_title =</span> <span class="st">"dog"</span>),
        <span class="kw">text_all</span>(<span class="dt">patent_abstract =</span> <span class="st">"dog"</span>)
      ),
      <span class="kw">eq</span>(<span class="dt">assingee_country =</span> <span class="kw">c</span>(<span class="st">"US"</span>, <span class="st">"CA"</span>))
    )
  )</code></pre></div>
</div>
<div id="why-use-the-dsl" class="section level2">
<h2 class="hasAnchor">
<a href="#why-use-the-dsl" class="anchor"></a>Why use the DSL?</h2>
<p>We can see that all three versions of the query shown above are equivalent:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">jsonlite::<span class="kw">minify</span>(query_v_1)
<span class="co">#&gt; {"_and":[{"_gte":{"patent_date":"2007-03-01"}},{"_or":[{"_text_all":{"patent_title":"dog"}},{"_text_all":{"patent_abstract":"dog"}}]},{"_or":[{"_eq":{"assingee_country":"US"}},{"_eq":{"assingee_country":"CA"}}]}]}</span>
jsonlite::<span class="kw">toJSON</span>(query_v_2, <span class="dt">auto_unbox =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; {"_and":[{"_gte":{"patent_date":"2007-03-01"}},{"_or":[{"_text_all":{"patent_title":"dog"}},{"_text_all":{"patent_abstract":"dog"}}]},{"_or":[{"_eq":{"assingee_country":"US"}},{"_eq":{"assingee_country":"CA"}}]}]}</span>
jsonlite::<span class="kw">toJSON</span>(query_v_3, <span class="dt">auto_unbox =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; {"_and":[{"_gte":{"patent_date":"2007-03-01"}},{"_or":[{"_text_all":{"patent_title":"dog"}},{"_text_all":{"patent_abstract":"dog"}}]},{"_or":[{"_eq":{"assingee_country":"US"}},{"_eq":{"assingee_country":"CA"}}]}]}</span></code></pre></div>
<p>…So why would you ever want to use method 3 over methods 1 and 2? There are two main reasons:</p>
<div id="query-validation" class="section level4">
<h4 class="hasAnchor">
<a href="#query-validation" class="anchor"></a>1. Query validation</h4>
<p><code><a href="../reference/search_pv.html">search_pv()</a></code> will check your query for errors if you use methods 2 or 3. This is not the case for method 1, were you would have to rely on the API’s error messages for guidance if your query is invalid…<code><a href="../reference/search_pv.html">search_pv()</a></code> checks queries for the following:</p>
<ul>
<li>The fields included in your query are <em>queryable</em> fields for the endpoint (i.e., the field can be used in the user query). For example, it would make sure that <code>assingee_country</code> can be used in the query argument if you sent the above query to the patents endpoint.</li>
<li>Your query fields are compatible with the comparison operators you used. For example, it would confirm that the <code>text_all</code> operator was used with fields whose type was “full text” (<code>patent_title</code> above).</li>
<li>You supplied the correct value type for the field (e.g., <code>patent_date</code> is a character, not an integer)</li>
</ul>
</div>
<div id="concise-easy-to-use-syntax-for-complex-queries" class="section level4">
<h4 class="hasAnchor">
<a href="#concise-easy-to-use-syntax-for-complex-queries" class="anchor"></a>2. Concise, easy to use syntax for complex queries</h4>
<p>Methods 1 and 3 shown above are both shorter than method 2, making them quicker. It’s also a lot easier to get the JSON syntax correct when using method 3 compared to method 1, because you don’t have to write any JSON at all using the DSL…This is important because the API is fairly picky about the query syntax, so it’s not trivial to get it correct. For example, the API will throw an error if you use a box in your JSON when is not absolutely necessary, even if your query is still valid JSON (e.g., <code>query = {"_gte":{"patent_date":["2007-03-01"]}}</code> will throw an error).</p>
<p>Compared to method 1, method 3 will correctly “or” together values if you put them in a vector. For example, in the query shown above, a vector of two values was given for <code>assingee_country</code> (<code>c("US", "CA")</code>). This safely converted the single “equals” statement in the third element of the query (<code>eq(assingee_country = c("US", "CA"))</code>) to two separate equals statements that are or’d together.<sup><a href="#fn1" id="ref1">1</a></sup></p>
</div>
</div>
<div id="basics-of-the-language" class="section level2">
<h2 class="hasAnchor">
<a href="#basics-of-the-language" class="anchor"></a>Basics of the language</h2>
<p>All of the functions that make up the DSL are found in the <code>qry_funs</code> list (e.g., <code>qry_funs$eq()</code>). You can evaluate code in the context of this list using the function <code><a href="../reference/with_qfuns.html">with_qfuns()</a></code>. See <code>?with_qfuns()</code> for an example that demonstrates how using this function saves you typing. There are three types of functions in <code>qry_funs</code>:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Comparison operator functions</strong> (<code>eq</code>, <code>neq</code>, <code>gt</code>, <code>gte</code>, <code>lt</code>, <code>lte</code>, <code>begins</code>, <code>contains</code>, <code>text_all</code>, <code>text_any</code>, <code>text_phrase</code>). These functions are used to compare a field to a value. For example, using the “less than or equal to” function (<code>lte</code>), we can filter out patents published after some date (e.g., <code>query = qry_funs$lte(patent_date = "2001-01-05")</code>). See the “comparison operators” section of the API’s <a href="http://www.patentsview.org/api/query-language.html">query language page</a> for a description of the 11 comparison operators, noting that the <code>patentsview</code> function equivalent of the operator just drops the leading “_”. One important thing to keep in mind is that certain comparison operators only work with certain data types. For example, you can’t use the <code>begins</code> function on <code>patent_abstract</code> because <code>patent_abstract</code> is of data type “full text” and <code>begins</code> only works with fields of data type “string.”</li>
<li>
<strong>Array functions</strong> (<code>and</code> and <code>or</code>). You can use these functions to logically combine the calls to the various comparison operators. For example, we can require that the patent date is less than or equal to 2001-01-05 <em>and</em> the inventor’s last name is “Ihaka” (<code>query = with_qfuns(and(lte(patent_date = "2001-01-05"), eq(inventor_last_name = "Ihaka")))</code>).</li>
<li>
<strong>not function</strong> (<code>not</code>). This function negates a comparison. In other words, the <code>not</code> function basically says that the comparison is not true, instead of is true. For example, we could search for patents that don’t have the word “hi” in their titles like this: <code>qry_funs$not(qry_funs$text_phrase(patent_title = "hi"))</code>.</li>
</ol>
</div>
<div id="query-examples" class="section level2">
<h2 class="hasAnchor">
<a href="#query-examples" class="anchor"></a>Query examples</h2>
<p><em>The following queries are intended for the patents endpoint</em></p>
<p>Patents linked to an assignee with 10 or fewer distinct (and disambiguated) inventors:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qry_funs$<span class="kw">lte</span>(<span class="dt">assignee_total_num_inventors =</span> <span class="dv">10</span>)
<span class="co">#&gt; {"_lte":{"assignee_total_num_inventors":10}}</span></code></pre></div>
<p>Patents assigned to the “CPC subsection”<sup><a href="#fn2" id="ref2">2</a></sup> of G12 (physics instruments):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qry_funs$<span class="kw">eq</span>(<span class="dt">cpc_subsection_id =</span> <span class="st">"G12"</span>)
<span class="co">#&gt; {"_eq":{"cpc_subsection_id":"G12"}}</span></code></pre></div>
<p>Patents that have an inventor listed on them whose first name contains “joh” and has an abstract with either the phrase “dog bark” or “cat meow,” but not the phrase “dog chain”:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/with_qfuns.html">with_qfuns</a></span>(
  <span class="kw">and</span>(
    <span class="kw">contains</span>(<span class="dt">rawinventor_first_name =</span> <span class="st">"joh"</span>),
    <span class="kw">text_phrase</span>(<span class="dt">patent_abstract =</span> <span class="kw">c</span>(<span class="st">"dog bark"</span>, <span class="st">"cat meow"</span>)),
    <span class="kw">not</span>(
      <span class="kw">text_phrase</span>(<span class="dt">patent_abstract =</span> <span class="kw">c</span>(<span class="st">"dog chain"</span>))
    )
  )
)
<span class="co">#&gt; {"_and":[{"_contains":{"rawinventor_first_name":"joh"}},{"_or":[{"_text_phrase":{"patent_abstract":"dog bark"}},{"_text_phrase":{"patent_abstract":"cat meow"}}]},{"_not":{"_text_phrase":{"patent_abstract":"dog chain"}}}]}</span></code></pre></div>
<p>Patents with an inventor whose disambiguated last name is “Smith” and with “cotton gin” in the patent title, or with an inventor whose disambiguated last name is “Hopper” and with “COBOL” in the patent title:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/with_qfuns.html">with_qfuns</a></span>(
  <span class="kw">or</span>(
    <span class="kw">and</span>(
      <span class="kw">eq</span>(<span class="dt">inventor_last_name =</span> <span class="st">"smith"</span>),
      <span class="kw">text_phrase</span>(<span class="dt">patent_title =</span> <span class="st">"cotton gin"</span>)
    ),
    <span class="kw">and</span>(
      <span class="kw">eq</span>(<span class="dt">inventor_last_name =</span> <span class="st">"hopper"</span>),
      <span class="kw">text_phrase</span>(<span class="dt">patent_title =</span> <span class="st">"COBOL"</span>)
    )
  )
)
<span class="co">#&gt; {"_or":[{"_and":[{"_eq":{"inventor_last_name":"smith"}},{"_text_phrase":{"patent_title":"cotton gin"}}]},{"_and":[{"_eq":{"inventor_last_name":"hopper"}},{"_text_phrase":{"patent_title":"COBOL"}}]}]}</span></code></pre></div>
<hr>
<p><sup id="fn1">1</sup> One may note that using “value arrays” is supposedly supported natively by the API. For example, the API documentation gives the following query as an example of their use: <code>'{"inventor_last_name":["Whitney","Hopper"]}'</code>. The problem with this is that the API is not consistent in its handling of value arrays. For many of the comparison operators, one cannot “or” together values using arrays. Thus, the query DSL in <code>patentsview</code> never relies on arrays when constructing the JSON.<sup><a href="#ref1">back</a></sup></p>
<p><sup id="fn2">2</sup> PatentsView gets the names of the CPC hierarchy wrong. For example, a “CPC subsection” according to PatentsView is actually a CPC class.<sup><a href="#ref2">back</a></sup></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#three-ways-to-write-the-same-query">Three ways to write the same query</a></li>
      <li><a href="#why-use-the-dsl">Why use the DSL?</a></li>
      <li><a href="#basics-of-the-language">Basics of the language</a></li>
      <li><a href="#query-examples">Query examples</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Christopher Baker.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
